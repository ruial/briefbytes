<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <meta name="description" content="When hosting applications for internal use, it is common to only allow connections from private networks. However, in addition to using a VPN, being able to authenticate and authorize users with a cen">
<meta name="keywords" content="oidc,ldap,prometheus">
<meta property="og:type" content="article">
<meta property="og:title" content="Secure Prometheus with OIDC or LDAP">
<meta property="og:url" content="https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/index.html">
<meta property="og:site_name" content="BRIEF BYTES">
<meta property="og:description" content="When hosting applications for internal use, it is common to only allow connections from private networks. However, in addition to using a VPN, being able to authenticate and authorize users with a cen">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/grafana.png">
<meta property="og:image" content="https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/auth.png">
<meta property="og:updated_time" content="2020-11-29T18:18:39.733Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Secure Prometheus with OIDC or LDAP">
<meta name="twitter:description" content="When hosting applications for internal use, it is common to only allow connections from private networks. However, in addition to using a VPN, being able to authenticate and authorize users with a cen">
<meta name="twitter:image" content="https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/grafana.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/desktop.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/android.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple.png">
          
        
    
    
    <title>Secure Prometheus with OIDC or LDAP</title>
    
    <link rel="stylesheet" href="/css/style.css">
    
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    
    
    
      <link rel="alternate" href="/atom.xml" title="BRIEF BYTES" type="application/atom+xml">
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/ruial">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2020/OpenVPN-deployment-with-Terraform-and-Ansible/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li>
        
        <li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none">Previous post</span>
      <span id="i-next" class="info" style="display:none">Next post</span>
      <span id="i-top" class="info" style="display:none">Back to top</span>
      <span id="i-share" class="info" style="display:none">Share post</span>
    </span>
    <br>
    <div id="share" style="display:none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&text=Secure Prometheus with OIDC or LDAP"><i class="fab fa-twitter" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&is_video=false&description=Secure Prometheus with OIDC or LDAP"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Secure Prometheus with OIDC or LDAP&body=Check out this article: https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/"><i class="fas fa-envelope" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-reddit" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-digg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&name=Secure Prometheus with OIDC or LDAP&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&t=Secure Prometheus with OIDC or LDAP"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-and-Grafana"><span class="toc-number">1.</span> <span class="toc-text">Prometheus and Grafana</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pomerium"><span class="toc-number">2.</span> <span class="toc-text">Pomerium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Authelia"><span class="toc-number">3.</span> <span class="toc-text">Authelia</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Architecture"><span class="toc-number">4.</span> <span class="toc-text">Architecture</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Secure Prometheus with OIDC or LDAP
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">BRIEF BYTES</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-11-28T22:42:50.000Z" itemprop="datePublished">2020-11-28</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/ldap/">ldap</a>, <a class="tag-link" href="/tags/oidc/">oidc</a>, <a class="tag-link" href="/tags/prometheus/">prometheus</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>When hosting applications for internal use, it is common to only allow connections from private networks. However, in addition to using a VPN, being able to authenticate and authorize users with a centralized identity system is often required for security reasons. I found two good alternatives that I will describe next, along with a monitoring use case.</p>
<h2 id="Prometheus-and-Grafana"><a href="#Prometheus-and-Grafana" class="headerlink" title="Prometheus and Grafana"></a>Prometheus and Grafana</h2><p><a href="https://prometheus.io" target="_blank" rel="noopener">Prometheus</a> is one of the most widely used systems for monitoring and alerting, while <a href="https://grafana.com" target="_blank" rel="noopener">Grafana</a> is very popular to create observability dashboards like this one:</p>
<img src="/2020/Secure-Prometheus-with-OIDC-or-LDAP/grafana.png" title="Grafana dashboard">
<p>Although some applications like Grafana already have support for OAuth or LDAP authentication, others like Prometheus delegate this responsibility to other systems.</p>
<h2 id="Pomerium"><a href="#Pomerium" class="headerlink" title="Pomerium"></a>Pomerium</h2><p><a href="https://www.pomerium.com/docs" target="_blank" rel="noopener">Pomerium</a> is an identity-aware proxy developed in Go. It can be placed in front of internal services and integrate with identity providers using <a href="https://en.wikipedia.org/wiki/OpenID_Connect" target="_blank" rel="noopener">OpenID Connect</a>. Out of the box, it supports identity providers like Google, Github and standard compliant OIDC providers like <a href="https://github.com/panva/node-oidc-provider" target="_blank" rel="noopener">node-oidc-provider</a> or <a href="https://identityserver4.readthedocs.io/en/latest" target="_blank" rel="noopener">IdentityServer</a>. Here’s a comprehensive <a href="https://www.scottbrady91.com/OpenID-Connect/Getting-Started-with-oidc-provider" target="_blank" rel="noopener">guide</a> to setup a provider.</p>
<h2 id="Authelia"><a href="#Authelia" class="headerlink" title="Authelia"></a>Authelia</h2><p><a href="https://www.authelia.com/docs" target="_blank" rel="noopener">Authelia</a> is an authentication and authorization server written in Go. It requires integration with a reverse proxy, such as Nginx. Instead of OIDC, LDAP is supported so it can be integrated with Active Directory (AD). On my tests I’ve used a local users file and Nginx, as it was the simplest approach. I also had success with AD and HAProxy (with LUA plugins), following the official documentation.</p>
<h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><p>Both auth technologies work quite well. It boils down to what you need to integrate with. Some additional features can be added on the reverse proxy or load balancer, like rate limiting or modifying request headers.</p>
<p>I’ve setup a <a href="https://github.com/ruial/monitoring-auth-demo" target="_blank" rel="noopener">demo project</a> to demonstrate their capabilities that uses the following architecture:</p>
<img src="/2020/Secure-Prometheus-with-OIDC-or-LDAP/auth.png" title="Auth flow">
<p>Besides proxy mode, which passes all traffic through, Pomerium also supports Forward authentication, which causes the reverse proxy to call an endpoint to verify if the user is authorized. User information is then placed on request headers. Both technologies make use of cookie sessions and redirect the user to the login page when not authenticated. They also support <a href="https://redis.io" target="_blank" rel="noopener">Redis</a>, which is important to preserve sessions during restarts or if using multiple instances.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display:none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/ruial">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display:none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-and-Grafana"><span class="toc-number">1.</span> <span class="toc-text">Prometheus and Grafana</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pomerium"><span class="toc-number">2.</span> <span class="toc-text">Pomerium</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Authelia"><span class="toc-number">3.</span> <span class="toc-text">Authelia</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Architecture"><span class="toc-number">4.</span> <span class="toc-text">Architecture</span></a></li></ol>
    </div>

    <div id="share-footer" style="display:none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&text=Secure Prometheus with OIDC or LDAP"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&is_video=false&description=Secure Prometheus with OIDC or LDAP"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Secure Prometheus with OIDC or LDAP&body=Check out this article: https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&title=Secure Prometheus with OIDC or LDAP"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&name=Secure Prometheus with OIDC or LDAP&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://briefbytes.com/2020/Secure-Prometheus-with-OIDC-or-LDAP/&t=Secure Prometheus with OIDC or LDAP"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020
    Rui Almeida
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/ruial">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>




    <script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-141298250-1","auto"),ga("send","pageview")</script>






</body>
</html>
